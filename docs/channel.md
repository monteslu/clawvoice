# ClawVoice - OpenClaw Integration

> How ClawVoice connects to your OpenClaw gateway.

See also: [Android Implementation](comms.md)

---

## Overview

ClawVoice connects directly to the **existing OpenClaw Gateway WebSocket** — no custom hooks or endpoints needed. It uses the same protocol as the iOS app, macOS app, and CLI.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    OpenClaw Gateway                          │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            Existing Gateway WebSocket (:18789)          │ │
│  │                                                         │ │
│  │   Protocol v3:                                          │ │
│  │   • connect.challenge / connect (auth)                  │ │
│  │   • chat.send / chat.history                            │ │
│  │   • chat events (delta/final streaming)                 │ │
│  │   • ping keepalive                                      │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                               │
                    WebSocket (wss://)
                               │
                    ┌─────────────────────┐
                    │   Android Device    │
                    │  • STT local        │
                    │  • TTS local        │
                    │  • Text → WS        │
                    └─────────────────────┘
```

## Setup

### 1. Start the Gateway

```bash
openclaw gateway --port 18789
```

For remote access via hsync:
```bash
hsync --local 18789 --name my-gateway
# → wss://my-gateway.shiv.to
```

### 2. Connect from Android

Enter gateway URL (e.g., `https://my-gateway.shiv.to`). First connect triggers pairing.

### 3. Approve Pairing

```bash
openclaw nodes approve <requestId>
```

The `requestId` is a UUID generated by the gateway, shown in the app.

---

## Client Identity

### Valid Client IDs

Use one of the pre-defined IDs recognized by the gateway:

| ID | Description |
|----|-------------|
| `openclaw-android` | Android app (ClawVoice) |
| `openclaw-ios` | iOS app |
| `openclaw-macos` | macOS app |
| `webchat-ui` | Browser webchat |
| `openclaw-control-ui` | Control UI |
| `cli` | Command line |

**ClawVoice should use:** `openclaw-android`

### Valid Modes

| Mode | Description | Origin Check |
|------|-------------|--------------|
| `webchat` | Shares sessions with web UI | Yes (browsers) |
| `ui` | Native UI client | No |
| `cli` | Command line | No |
| `node` | Device with capabilities | No |
| `backend` | Backend service | No |

**ClawVoice should use:** `webchat` for session sharing, but see Origin section below.

---

## Origin Checking (Important!)

The gateway enforces **origin checking** for `webchat` mode to prevent browser CSRF attacks.

### The Problem

- Browsers can't spoof Origin headers (security)
- Native apps CAN set any Origin header
- If native app sends no Origin, gateway rejects with "origin not allowed"

### Solution: Send Origin header

```kotlin
val request = Request.Builder()
    .url(wsUrl)
    .header("Origin", gatewayUrl)  // e.g., "https://my-gateway.shiv.to"
    .build()
```

User must add their gateway URL to `gateway.controlUi.allowedOrigins` in config:

```json
{
  "gateway": {
    "controlUi": {
      "allowedOrigins": ["https://my-gateway.shiv.to"]
    }
  }
}
```

---

## Pairing Flow

### How It Works

1. App connects to gateway WebSocket
2. Gateway sends `connect.challenge` with nonce
3. App signs challenge and sends `connect` request
4. Gateway returns `pairing_required` error with `requestId` (UUID)
5. App displays requestId to user
6. User runs `openclaw nodes approve <requestId>`
7. Gateway sends `device.paired` event with deviceToken
8. App saves token for future connections

### Flow Diagram

```
App                                    Gateway
 │                                        │
 │──── WebSocket connect ────────────────▶│
 │                                        │
 │◀─── connect.challenge {nonce, ts} ─────│
 │                                        │
 │──── connect {device, auth} ───────────▶│
 │                                        │
 │◀─── error: pairing_required ───────────│
 │     requestId: "550e8400-e29b-..."     │
 │                                        │
 │         [User runs: openclaw nodes approve 550e8400-...]
 │                                        │
 │◀─── event: device.paired ──────────────│
 │     {deviceToken: "..."}               │
 │                                        │
 │     [Save token, reconnect]            │
```

---

## Message Filtering

Filter these from display/TTS:

| Pattern | Purpose |
|---------|---------|
| `HEARTBEAT_OK` | Heartbeat ack |
| `NO_REPLY` | Silent response |
| `MEDIA:...` | Audio file path |
| `[[reply_to_current]]` | Reply tag |
| `[[reply_to:...]]` | Reply tag with ID |

---

## Related

- [Android Implementation](comms.md) — Kotlin code details
- [Gateway Protocol](https://docs.openclaw.ai/gateway/protocol) — Full protocol spec
